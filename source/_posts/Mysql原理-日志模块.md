title: Mysql原理-日志模块
author: v-vampires
date: 2020-02-16 18:21:04
tags:
---
主要涉及三个模块

## redo log（重做日志）
### 作用
保证事物的持久性，当发生故障，尚有脏页的数据未写入磁盘时，在mysql重启服务的时候根据redo log进行重做，从而达到事物的持久性
### 原理
在mysql里面，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。为了解决这个问题，MySQL 的设计者就用了类似酒店掌柜粉板的思路来提升更新效率；而粉板和账本配合的整个过程，其实就是 MySQL 里经常说到的 WAL 技术，WAL 的全称是 Write-Ahead Logging（预写式日志），它的关键点就是先写日志，再写磁盘，也就是先写粉板，等不忙的时候再写账本。

具体来说，当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log（粉板）里面，并更新内存，这个时候更新就算完成了。那么引擎什么时候再将数据从内存中刷到磁盘呢？有以下几种情况：

1. 系统空闲时
2. 有新的更新，但是redo log已经满了
3. 内存不够用时

InnoDB 的 redo log 是固定大小的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么这块“粉板”总共就可以记录 4GB 的操作。从头开始写，写到末尾就又回到开头循环写，如下面这个图所示 
![upload successful](/images/pasted-17.png)
write pos 是当前记录的位置，一边写一边后移，写到第 3 号文件末尾后就回到 0 号文件开头。checkpoint 是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。

有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失（内存没有了，但是可以根据redo log 进行重做），这个能力称为 crash-safe

## bin log
### 作用
1. 用于主从复制，从库利用主库上的binlog进行重播，实现主从同步
2. 用于数据库基于时间点的还原

### 原理
事务提交的时候，一次性将事务中的sql语句（一个事物可能对应多个sql语句）按照一定的格式记录到binlog中。binlog是可以追加写的，追加写是指binlog文件写到一定大小后，会切换到下一个，并不会覆盖以前的日志

数据还原：当需要数据恢复到指定的某一秒时，比如某天下午两点发现中午十二点有一次误删表，需要找回数据，那你可以这么做：
1. 首先，找到最近的一次全量备份，如果你运气好，可能就是昨天晚上的一个备份，把这个备份恢复到临时库
2. 从备份的时间点开始，将备份的 binlog 依次取出来，重放到中午误删表之前的那个时刻。
3. 这时临时库就跟误删之前的线上库一样了，然后你可以把表数据从临时库取出来，按需要恢复到线上库去

### 为什么说binlog具有crash-safe能力
假如只有binlog，有可能是先提交数据再写binlog，如果提交数据之后，数据库崩溃了，当数据库重启后，数据库里面有数据，而binlog则没有数据，当进行主从复制或者基于时间点还原时，则会造成数据的不一致；同理如果先先binlog，再提交数据，如果写完binlog后，数据库奔溃了，当数据库恢复后，数据库里面则没有数据，当进行主从复制或者基于时间点还原时，还会造成数据的不一致

### 两阶段提交
由于 redolog 和 binlog 是两个独立的逻辑，如果不用两阶段提交，要么就是先写完 redolog 再写 binlog，或者采用反过来的顺序，都会存在问题
1. 先写redolog，后写binlog：当写完redolog后，mysql崩溃重启后，会根据redolog进行数据恢复；然而没有写binlog，如果根据binlog恢复临时库的话，数据就会丢失了。造成了数据的不一致
2. 先写binlog，后写redolog：当写完binlog后，mysql崩溃重启后，由于redolog还没有写，数据就不会恢复，但是用binlog恢复临时库的话，数据就会多了。与原来的库不同，造成了数据的不一致

两阶段提交的实现方式如下：
1. redolog prepare阶段
2. 写binlog
3. redolog commit阶段

当系统在1阶段完成，2阶段之前奔溃，重启后恢复时：发现没有binlog，redolog也没有commit则回滚；备份恢复时：没有binlog，数据一致

当系统在2阶段完成，3阶段之前奔溃，重启后恢复时：发现有binlog，redolog也prepare了则自动提交；备份恢复时：有binlog，数据一致

## undo log（回滚日志）
### 作用
用于事物的回滚，同时可以提供多版本并发控制下的读（MVCC）
### 原理
再Mysql中，每条记录再更新的时候都会同时记录一条回滚操作。记录上的最新值，都可以通过回滚操作得到前一个状态的值。可以简单的认为，当delete一条记录时，undo log会记录一条insert，反之亦然，当update一条记录时，它记录一条对应相反的update记录。另外undo log也会产生redo log，因为undo log 也需要持久性保护。如果假设一个值从 1 被按顺序改成了 2、3、4，在undo log里面就会有类似下面的记录
![upload successful](/images/pasted-18.png)
可以看到同一条记录再系统中存在多个版本，这也就是数据库的多版本并发控制（MVCC）